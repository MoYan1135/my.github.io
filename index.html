<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AIæ™ºèƒ½èŠå¤©åŠ©æ‰‹</title>
    <style>
        body { 
            font-family: Arial, sans-serif; 
            max-width: 800px; 
            margin: 0 auto; 
            padding: 20px; 
            background-color: #f9f9f9;
        }
        h1 {
            color: #333;
            text-align: center;
            margin-bottom: 20px;
        }
        .chat-container { 
            border: 1px solid #ddd; 
            height: 400px; 
            overflow-y: auto; 
            padding: 10px; 
            margin-bottom: 10px; 
            background-color: white;
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        .user { 
            background: #e3f2fd; 
            padding: 8px; 
            margin: 5px; 
            border-radius: 10px; 
            max-width: 80%;
            margin-left: auto;
        }
        .assistant { 
            background: #f5f5f5; 
            padding: 8px; 
            margin: 5px; 
            border-radius: 10px; 
            max-width: 80%;
        }
        .system {
            background: #ffebee;
            padding: 8px;
            margin: 5px;
            border-radius: 10px;
            text-align: center;
            font-style: italic;
            color: #c62828;
        }
        .file-message {
            background: #e8f5e9;
            padding: 8px;
            margin: 5px;
            border-radius: 10px;
            max-width: 80%;
            margin-left: auto;
        }
        .file-info {
            display: flex;
            align-items: center;
            margin-bottom: 5px;
        }
        .file-icon {
            font-size: 24px;
            margin-right: 10px;
        }
        .file-name {
            font-weight: bold;
            margin-right: 10px;
        }
        .file-size {
            color: #666;
            font-size: 0.9em;
        }
        .file-preview {
            margin-top: 5px;
            max-width: 100%;
            border-radius: 5px;
        }
        .input-area { 
            display: flex; 
            gap: 10px; 
            margin-top: 15px;
        }
        input { 
            flex: 1; 
            padding: 10px; 
            border: 1px solid #ddd; 
            border-radius: 5px; 
        }
        button { 
            padding: 10px 20px; 
            background: #007bff; 
            color: white; 
            border: none; 
            border-radius: 5px; 
            cursor: pointer; 
            transition: background 0.3s;
        }
        button:hover {
            background: #0056b3;
        }
        .file-input-container {
            position: relative;
            display: inline-block;
        }
        .file-input {
            position: absolute;
            left: 0;
            top: 0;
            opacity: 0;
            width: 100%;
            height: 100%;
            cursor: pointer;
        }
        .file-input-button {
            padding: 10px 15px;
            background: #28a745;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            transition: background 0.3s;
        }
        .file-input-button:hover {
            background: #218838;
        }
        .upload-status {
            margin-top: 5px;
            font-size: 0.9em;
            color: #666;
        }
        .typing-indicator {
            display: none;
            background: #f5f5f5;
            padding: 8px;
            margin: 5px;
            border-radius: 10px;
            max-width: 80%;
        }
        .typing-dots {
            display: inline-block;
            position: relative;
            width: 60px;
            height: 20px;
        }
        .typing-dots span {
            position: absolute;
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #999;
            animation: typing 1.5s infinite ease-in-out;
        }
        .typing-dots span:nth-child(1) {
            left: 0;
            animation-delay: 0s;
        }
        .typing-dots span:nth-child(2) {
            left: 15px;
            animation-delay: 0.2s;
        }
        .typing-dots span:nth-child(3) {
            left: 30px;
            animation-delay: 0.4s;
        }
        @keyframes typing {
            0%, 60%, 100% {
                transform: translateY(0);
                opacity: 0.4;
            }
            30% {
                transform: translateY(-10px);
                opacity: 1;
            }
        }
    </style>
</head>
<body>
    <h1>ğŸ¤– AIæ™ºèƒ½èŠå¤©åŠ©æ‰‹</h1>
    <div id="chat-container" class="chat-container">
        <div class="assistant">
            <strong>AI:</strong> æ‚¨å¥½ï¼æˆ‘æ˜¯AIæ™ºèƒ½åŠ©æ‰‹ï¼Œå¯ä»¥å›ç­”æ‚¨çš„é—®é¢˜æˆ–å¸®åŠ©æ‚¨åˆ†æä¸Šä¼ çš„æ–‡ä»¶ã€‚è¯·å‘Šè¯‰æˆ‘æ‚¨éœ€è¦ä»€ä¹ˆå¸®åŠ©ï¼Ÿ
        </div>
    </div>
    
    <div class="input-area">
        <div class="file-input-container">
            <button class="file-input-button">ğŸ“ æ·»åŠ æ–‡ä»¶</button>
            <input type="file" id="file-input" class="file-input" multiple>
        </div>
        <input type="text" id="user-input" placeholder="è¾“å…¥æ‚¨çš„é—®é¢˜..." onkeypress="handleKeyPress(event)">
        <button onclick="sendMessage()">å‘é€</button>
    </div>
    <div id="upload-status" class="upload-status"></div>

    <script>
        // æ›¿æ¢ä¸ºæ‚¨çš„èŠ±ç”Ÿå£³å¤–ç½‘åœ°å€
        const API_BASE = 'https://es1045327pj3.vicp.fun';
        let selectedFiles = [];
        
        // æ–‡ä»¶è¾“å…¥å¤„ç†
        document.getElementById('file-input').addEventListener('change', function(e) {
            selectedFiles = Array.from(e.target.files);
            updateUploadStatus();
        });
        
        function updateUploadStatus() {
            const statusElement = document.getElementById('upload-status');
            if (selectedFiles.length === 0) {
                statusElement.textContent = '';
            } else {
                const fileNames = selectedFiles.map(file => file.name).join(', ');
                statusElement.textContent = `å·²é€‰æ‹© ${selectedFiles.length} ä¸ªæ–‡ä»¶: ${fileNames}`;
            }
        }
        
        function handleKeyPress(event) {
            if (event.key === 'Enter') {
                sendMessage();
            }
        }
        
        async function sendMessage() {
            const userInput = document.getElementById('user-input');
            const message = userInput.value.trim();
            
            // å¦‚æœæ²¡æœ‰æ¶ˆæ¯ä¹Ÿæ²¡æœ‰æ–‡ä»¶ï¼Œç›´æ¥è¿”å›
            if (!message && selectedFiles.length === 0) return;
            
            // æ·»åŠ ç”¨æˆ·æ¶ˆæ¯åˆ°èŠå¤©çª—å£
            if (message) {
                addMessage('user', message);
            }
            
            // æ·»åŠ æ–‡ä»¶æ¶ˆæ¯åˆ°èŠå¤©çª—å£
            if (selectedFiles.length > 0) {
                addFileMessage(selectedFiles);
            }
            
            userInput.value = '';
            userInput.disabled = true;
            
            // æ˜¾ç¤ºæ­£åœ¨è¾“å…¥æŒ‡ç¤ºå™¨
            showTypingIndicator();
            
            try {
                // å‡†å¤‡å‘é€çš„æ•°æ®
                let requestData = {
                    model: '',
                    messages: [],
                    temperature: 0.7,
                    max_tokens: 1000
                };
                
                // å¦‚æœæœ‰æ–‡æœ¬æ¶ˆæ¯ï¼Œæ·»åŠ åˆ°æ¶ˆæ¯åˆ—è¡¨
                if (message) {
                    requestData.messages.push({ role: 'user', content: message });
                }
                
                // å¦‚æœæœ‰æ–‡ä»¶ï¼Œå‡†å¤‡ä¸Šä¼ 
                if (selectedFiles.length > 0) {
                    // åˆ›å»ºFormDataå¯¹è±¡ç”¨äºæ–‡ä»¶ä¸Šä¼ 
                    const formData = new FormData();
                    
                    // æ·»åŠ æ–‡æœ¬æ¶ˆæ¯ï¼ˆå¦‚æœæœ‰ï¼‰
                    if (message) {
                        formData.append('message', message);
                    }
                    
                    // æ·»åŠ æ‰€æœ‰æ–‡ä»¶
                    selectedFiles.forEach((file, index) => {
                        formData.append(`file${index}`, file);
                    });
                    
                    // å‘é€æ–‡ä»¶åˆ°æœåŠ¡å™¨
                    const fileResponse = await fetch(API_BASE + '/upload', {
                        method: 'POST',
                        body: formData
                    });
                    
                    if (fileResponse.ok) {
                        const fileResult = await fileResponse.json();
                        // å°†æ–‡ä»¶ä¿¡æ¯æ·»åŠ åˆ°æ¶ˆæ¯ä¸­
                        requestData.messages.push({ 
                            role: 'user', 
                            content: `æˆ‘ä¸Šä¼ äº†${selectedFiles.length}ä¸ªæ–‡ä»¶: ${selectedFiles.map(f => f.name).join(', ')}` 
                        });
                    } else {
                        throw new Error('æ–‡ä»¶ä¸Šä¼ å¤±è´¥');
                    }
                }
                
                // å‘é€èŠå¤©è¯·æ±‚
                const response = await fetch(API_BASE + '/v1/chat/completions', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(requestData)
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const data = await response.json();
                
                // éšè—æ­£åœ¨è¾“å…¥æŒ‡ç¤ºå™¨
                hideTypingIndicator();
                
                // æ·»åŠ AIå›å¤åˆ°èŠå¤©çª—å£
                addMessage('assistant', data.choices[0].message.content);
            } catch (error) {
                // éšè—æ­£åœ¨è¾“å…¥æŒ‡ç¤ºå™¨
                hideTypingIndicator();
                
                addMessage('system', 'è¯·æ±‚å¤±è´¥ï¼š' + error.message);
            } finally {
                userInput.disabled = false;
                userInput.focus();
                
                // æ¸…ç©ºå·²é€‰æ‹©çš„æ–‡ä»¶
                selectedFiles = [];
                document.getElementById('file-input').value = '';
                updateUploadStatus();
            }
        }
        
        function addMessage(role, content) {
            const container = document.getElementById('chat-container');
            const messageDiv = document.createElement('div');
            messageDiv.className = role;
            
            let prefix = '';
            switch(role) {
                case 'user': prefix = 'æ‚¨'; break;
                case 'assistant': prefix = 'AI'; break;
                case 'system': prefix = 'ç³»ç»Ÿ'; break;
            }
            
            messageDiv.innerHTML = `<strong>${prefix}:</strong> ${content}`;
            container.appendChild(messageDiv);
            container.scrollTop = container.scrollHeight;
        }
        
        function addFileMessage(files) {
            const container = document.getElementById('chat-container');
            const messageDiv = document.createElement('div');
            messageDiv.className = 'file-message';
            
            let fileHTML = '<strong>æ‚¨:</strong><br>';
            
            files.forEach(file => {
                const fileSize = formatFileSize(file.size);
                const fileIcon = getFileIcon(file.type, file.name);
                
                fileHTML += `
                    <div class="file-info">
                        <span class="file-icon">${fileIcon}</span>
                        <span class="file-name">${file.name}</span>
                        <span class="file-size">(${fileSize})</span>
                    </div>
                `;
                
                // å¦‚æœæ˜¯å›¾ç‰‡ï¼Œæ˜¾ç¤ºé¢„è§ˆ
                if (file.type.startsWith('image/')) {
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        const img = document.createElement('img');
                        img.src = e.target.result;
                        img.className = 'file-preview';
                        img.style.maxWidth = '200px';
                        img.style.maxHeight = '150px';
                        messageDiv.appendChild(img);
                    };
                    reader.readAsDataURL(file);
                }
            });
            
            messageDiv.innerHTML = fileHTML;
            container.appendChild(messageDiv);
            container.scrollTop = container.scrollHeight;
        }
        
        function formatFileSize(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }
        
        function getFileIcon(type, name) {
            if (type.startsWith('image/')) return 'ğŸ–¼ï¸';
            if (type.startsWith('video/')) return 'ğŸ¥';
            if (type.startsWith('audio/')) return 'ğŸµ';
            
            const ext = name.split('.').pop().toLowerCase();
            switch(ext) {
                case 'pdf': return 'ğŸ“„';
                case 'doc':
                case 'docx': return 'ğŸ“';
                case 'xls':
                case 'xlsx': return 'ğŸ“Š';
                case 'ppt':
                case 'pptx': return 'ğŸ“‘';
                case 'zip':
                case 'rar': return 'ğŸ“¦';
                case 'txt': return 'ğŸ“ƒ';
                default: return 'ğŸ“';
            }
        }
        
        function showTypingIndicator() {
            const container = document.getElementById('chat-container');
            const typingDiv = document.createElement('div');
            typingDiv.className = 'typing-indicator';
            typingDiv.id = 'typing-indicator';
            typingDiv.innerHTML = `
                <strong>AI:</strong> æ­£åœ¨è¾“å…¥
                <div class="typing-dots">
                    <span></span>
                    <span></span>
                    <span></span>
                </div>
            `;
            container.appendChild(typingDiv);
            container.scrollTop = container.scrollHeight;
            typingDiv.style.display = 'block';
        }
        
        function hideTypingIndicator() {
            const typingDiv = document.getElementById('typing-indicator');
            if (typingDiv) {
                typingDiv.remove();
            }
        }
    </script>
</body>
</html>
